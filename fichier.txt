1. backend/.env :
# MongoDB
MONGODB_URI=mongodb+srv://bendev:bendev2799@cluster0.g63wzbs.mongodb.net/apmf-db?retryWrites=true&w=majority&appName=Cluster0

# JWT
JWT_SECRET_KEY=c9f0f895fb98ab9159f51fd0297e236d1b1f17c9a3e4b6c8d7e9f0a1b2c3d4e5

# API
API_PORT=5000
ALLOWED_ORIGINS=http://localhost:3000

# Admin par défaut
DEFAULT_ADMIN_USERNAME=admin
DEFAULT_ADMIN_PASSWORD=admin123
DEFAULT_ADMIN_EMAIL=benbenedictin@gmail.com


2. backend/Dockerfile :
FROM python:3.11-slim

# Install deps système (gcc pour compilation du code)
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements et install Python deps (sans cache pour fraîcheur)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy source code
COPY . .

# Rend entrypoint exécutable
RUN chmod +x entrypoint.sh

# Expose port Flask
EXPOSE 5000

# Utilise entrypoint pour runtime init + app
ENTRYPOINT ["./entrypoint.sh"]


3. backend/entrypoint.sh :
#!/bin/bash
set -e  # Arrête sur erreur

# Log pour debug
echo "Démarrage backend : Chargement env et init DB..."

# Init admin si MONGODB_URI existe et fix_admin.py existe (seulement première fois)
if [ -n "$MONGODB_URI" ] && [ -f "fix_admin.py" ]; then
  echo "Initialisation DB : Création admin si absent..."
  python fix_admin.py || echo "Init admin ignoré (déjà existant ou erreur non critique)"
else
  echo "ℹSkip init admin (MONGODB_URI absent ou script manquant)"
fi

# Lance l'app Flask
echo "Lancement Flask sur port 5000..."
exec python app.py


4. collector/.env :
# MongoDB Atlas
MONGODB_URI=mongodb+srv://bendev:bendev2799@cluster0.g63wzbs.mongodb.net/apmf-db?retryWrites=true&w=majority&appName=Cluster0

# Backend API
BACKEND_URL=http://apmf-backend:5000

# SSH Configuration
SSH_USER=apmf
SSH_KEY_PATH=~/.ssh/apmf_key
# SSH_KEY_PATH=~/.ssh/apmf_key

# Collector Settings
POLL_INTERVAL_SECONDS=15
POLL_MAX_WORKERS=4

# Logging
LOG_LEVEL=INFO


5. collector/Dockerfile :
FROM python:3.11-slim

WORKDIR /app

# Dépendances système : Accélérer avec --no-install-recommends
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    openssh-client \
    && rm -rf /var/lib/apt/lists/*

# Créer dossier SSH sécurisé
RUN mkdir -p /root/.ssh && rm -rf /root/.ssh/apmf_key

# Installer Python deps
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copier code
COPY . .

# Exposer port healthcheck (optionnel)
EXPOSE 8080

# Lancer collector (ajuste si c'est metrics_script.py)
CMD ["python", "-u", "collector.py"]


6. frontend/.env :
VITE_API_URL=http://localhost:5000

7. frontend/Dockerfile :
# Build stage
FROM node:22-alpine AS build

WORKDIR /app

# Copier package.json et installer deps (npm ci pour lockfile)
COPY package.json package-lock.json* ./
RUN npm ci --prefer-offline --no-audit --no-fund

# Copier source code
COPY . .

# Build Vite (génère /app/dist)
RUN npm run build

# Debug : Vérifier que dist existe (retire cette ligne en prod)
RUN ls -la /app && ls -la /app/dist

# Serve stage avec Nginx
FROM nginx:alpine

# Copier le build Vite (dist au lieu de build)
COPY --from=build /app/dist /usr/share/nginx/html

# Config Nginx pour proxy API
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Permissions pour SPA routing
RUN rm /etc/nginx/conf.d/default.conf
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 3000

CMD ["nginx", "-g", "daemon off;"]


8. docker-compose.yml :
services:
  backend:
    build: ./backend
    container_name: apmf-backend
    restart: always
    ports:
      - "${API_PORT:-5000}:5000"
    environment:
      - MONGODB_URI=${MONGODB_URI}
      - JWT_SECRET=${JWT_SECRET_KEY}
      - FLASK_ENV=production
    volumes:
      - ./backend:/app
    networks:
      - apmf-net

  collector:
    build: ./collector
    container_name: apmf-collector
    restart: always
    environment:
      - BACKEND_URL=http://apmf-backend:5000
      - MONGODB_URI=${MONGODB_URI}
      - COLLECTOR_INTERVAL=${POLL_INTERVAL_SECONDS:-15}
      - SSH_TIMEOUT=${SSH_TIMEOUT:-10}
    depends_on:
      - backend
    volumes:
      - ./ssh_keys:/root/.ssh # Tes clés SSH
      - ./collector:/app
    networks:
      - apmf-net

  frontend:
    build: ./frontend
    container_name: apmf-frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
    environment:
      - VITE_API_URL=http://localhost:5000
    networks:
      - apmf-net

networks:
  apmf-net:
    driver: bridge
